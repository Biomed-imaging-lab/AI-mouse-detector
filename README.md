# Анализ поведения лабораторных мышей

Это приложение предоставляет веб-интерфейс для анализа видеэкспериментов над лабораторными мышами. Тип видеоэксперимента: open field (<<открытое поле>>). Входные данные должны выглядеть следующим образом:
![Пример входных данных](docs/images/input.png)

## Возможности

- Обнаружение и отслеживание мыши с помощью YOLO
- Анализ и классификация поведения
- Отслеживание скорости и положения
- Зональный анализ (Центральная, Внутренняя, Средняя и Внешняя зоны)
- Автоматическая генерация графиков
- Выгрузка результатов (данные Excel/CSV и отладочное видео)

## Установка и запуск

### Запуск через Docker

Для запуска приложения через Docker:

1. Установите [Docker](https://docs.docker.com/get-docker/) и [Docker Compose](https://docs.docker.com/compose/install/)

2. Клонируйте репозиторий:
```bash
git clone https://github.com/Biomed-imaging-lab/AI-mouse-detector.git
cd MouseDetector
```

3. Соберите и запустите контейнер:
```bash
docker-compose up --build
```
><span style="color:red">**ВАЖНО**</span>: После выполнения данной команды на локальном компьютере (на котором запускается команда) будет создан docker-образ весом ~15Гб. Убедитесь в наличии свободного пространства на диске.

4. Откройте веб-браузер и перейдите по адресу:
```
http://localhost:8501
```

5. После завершения работы выполните команду:
```bash
docker-compose down
```
><span style="color:red">**ВАЖНО**</span>: Это остановит работу контейнера, но не удалит образ. При необходимости удалить образ выполните инструкции ниже.

Для удаления образа:
- Выполнить команду:
```bash
docker images
```
- Найти образ с названием `mousedetector-mouse-detector`
- Посмотреть его поле `IMAGE ID`
- Выполнить команду:
```bash
docker rmi <IMAGE ID>
```
где IMAGE ID – значение, указанное в столбце IMAGE ID для образа `mousedetector-mouse-detector`
#### Структура данных

При использовании Docker:
- Загруженные видео сохраняются в папке `uploads/`
- Результаты анализа сохраняются в папке `mouse_data/`
- Эти папки автоматически создаются при первом запуске

### Локальная установка (альтернативный способ)

Для выполнения локальной установки необходим установленный Python версии 3.11 и выше.

1. Клонируйте репозиторий:
```bash
git clone https://github.com/Biomed-imaging-lab/AI-mouse-detector.git
cd MouseDetector
```
2. Создайте виртуальное окружение:
```bash
python -m venv .venv
```
3. Активируйте виртуальное окружение в зависимости от операционной системы, на которой разворачивается проект (см. таблицу по ссылке): https://docs.python.org/3/library/venv.html#how-venvs-work 

4. Установите необходимые зависимости:
```bash
pip install -r requirements.txt
```
><span style="color:red">**ВАЖНО**</span>: После выполнения данной команды на локальном компьютере (на котором запускается команда) будут установлены необходимые библиотеки и пакеты обшим весом ~15Гб. Убедитесь в наличии свободного пространства на диске.
## Запуск приложения (для локальной установки)

1. Запустите приложение Streamlit:
```bash
streamlit run app.py
```

2. Откройте веб-браузер и перейдите по URL, указанному в терминале (обычно http://localhost:8501)

## Использование приложения

1. **Загрузка файлов**
   - Загрузите видеофайл (формат MP4 или AVI). Вид входных данных указан в начале README.

2. **Настройка анализа**
   - Выберите, нужно ли создавать отладочное видео
      - Отладочное видео – это исходное видео, на котором отображаются найденные зоны арены и ключевые точки мыши. Оно не перезаписывает старое видео, а создается вместе с ним. Может быть полезно для визуальной оценки работы алгоритма (находятся ли зоны арены или сама мышь).
   - Выберите, нужно ли создавать графики анализа
      - Графики анализа представляют из себя различные зависимости и карты, построенные на основе полученных данных. Полный список графиков анализа предоставлен ниже

3. **Запуск анализа**
   - Нажмите кнопку "Запуск" для начала обработки
   - Дождитесь завершения анализа
      - В зависимости от мощности машины, на которой ведется обработка, и размера видео анализ может занимать продолжительное время. В среднем для видеоролика длиной 5 минут анализ занимает 40-50 минут.
   ><span style="color:red">**ВАЖНО**</span>: Не обновляйте страницу после получения результатов, иначе в противном случае результаты не будут доступны для скачивания из интерфейса Streamlit. Результаты сохраняются локально в директорию проекта.

4. **Просмотр результатов**
   - Просмотр предварительных данных
   - Скачивание полных данных в формате Excel
   - Просмотр отладочного видео (если было создано)
   - Просмотр сгенерированных графиков (если были созданы)
   - Скачивание необходимых результатов

## Выходные файлы

Приложение генерирует несколько типов выходных файлов:

- Excel файл с подробными данными анализа
- Отладочное видео, показывающее обнаружение и отслеживание (опционально)
- Различные графики анализа:
  - Траектория движения мыши
  - График скорости во времени
  - Тепловая карта позиции
  - Тепловая карта скоростей
  - Гистограммы зонального анализа
  - Траектория мыши с указанием класса поведения в каждой точке

## Примечания

- Обработка больших видеофайлов может занять некоторое время
- Убедитесь, что у вас достаточно места на диске для выходных файлов
- При использовании Docker все данные сохраняются в локальных папках `uploads/` и `mouse_data/`
- Не останавливайте контейнер во время обработки видео
- При обновлении страницы в браузере текущие результаты анализа будут потеряны 